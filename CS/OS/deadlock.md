## 📌 교착 상태(Deadlock)

### 💡 사전 지식
1. 프로세스가 자원을 사용하는 절차
- Request -> Allocate -> Use -> Release

2. 자원 할당 그래프(Resource-Allocation Graph)
- 자원과 프로세르를 노드로, 각 자원의 할당과 요청 정보를 간선으로 표현한 그래프

<br>

### ✔️ 교착 상태란?
- 두 이상의 프로세스가 서로가 가진 자원을 기다리며 block된 상태

<br>

### ✔️ 교착 상태가 발생하는 조건
- 상호 배제(Mutual Exclusion)
- 비선점(No Preemption)
    - 프로세스가 자원을 소유하고 있을 때, 다른 프로세스에게 자원을 빼앗기지 않는다.
    - 다른 프로세스가 해당 자원을 소유하기 위해서는 자원을 소유하고 있는 프로세스가 자원을 놓을 때까지 기다려야 한다.
- 보유 대기(Hold and wait)
    - 자원을 가진 프로세스가 다른 자원을 기다릴 때, 보유하고 있는 자원을 놓지 않고 대기하는 상태
- 순환 대기(Circular wait)

<br>

### ✔️ 교착 상태 해결법 종류
- 예방(Deadlock prevention)
- 회피(Deadlock Avoidance)
- 탐지 및 회복(Deadlock Detection and revoery)
- 무시(Deadlock Ignorance)

<br>

### ✔️ 교착 상태 해결법 - 예방
- 자원 할당 시 Deadlock의 4가지 필요조건 중 하나의 조건을 만족되지 않도록 하는 방법
- 조건에 따른 방지법
    - 상호 배제 방지
        - 자원에 대해 상보 배제를 방지하면 `동기화(Synchronization)` 문제가 발생할 수 있다.
        
    - 비선점 방지
        - 프로세스가 다른 자원 요청하고 기다리는 동안 보유한 자원이 선점될 수 있도록 구현

    - 점유와 대기 방지
        - 방법1
            - 프로세스가 처음 시작될 때, 필요한 자원을 모두 할당하는 방법
            - 만약 필요한 자원을 모두 할당할 수 없을 때, 해당 프로세스의 실행은 잠시 보류한다.
        - 방법2
            - 새로운 자원이 필요한 경우 이미 보유한 자원을 모두 반환하고 다시 요청하는 방법

    - 순환 대기 방지
        - 모든 유형의 자원에 할당 순서를 정하여, 정해진 순서대로 자원을 할당하도록 구현
        - 순서상 앞에 있는 자원을 할당받지 못하면, 뒤에 있는 자원을 요청하지 못하도록 구현
- `예방(prevention)`방법은 자원의 이용률이 감소하고 `기아현상(starvation)`이 발생할 수 있다.

<br>

### ✔️ 교착 상태 해결법 - 회피
- safe state와 unsafe state
    - safe state
        - 교착 상태가 발생하지 않는 상태
        - safe sequence가 존재하는 상태
        - safe sequence는 교착 상태를 발생시키지 않고 자원을 할당할 수 있는 자원 할당 순서

    - unsafe state
        - 교착 상태가 발생할 가능성이 있는 상태
- `회피(avoidance)` 방법은 unsafe state에 들어가는 것을 방지할 수 있다.
    - 자원을 할당해도 시스템이 safe state라는 것을 확인한 후 자원을 할당한다.
- 각 자원의 인스턴스가 한 개 일 때
    - 자원 할당 그래프 이용
- 각 자원의 인스턴스가 한 개 이상일 때
    - 은행원 알고리즘(Banker's Algorithm) 이용
        
<br>

### ✔️ 교착 상태 해결법 - 탐지 및 회복
- 교착 상태의 발생을 허용하고 탐지(detection) 방법을 통해 교착 상태를 탐지, 교착 상태 발생 시 회복(recover) 작업을 수행
- 탐지 방법
    - 각 자원의 인스턴스가 한 개 일 때
        - wait for graph 이용
    - 각 자원의 인스턴스가 한 개 이상일 때
        - `은행원 알고리즘`과 비슷한 알고리즘 이용
            - 기존의 은행원 알고리즘보다 낙관적으로 탐색을 진행

- 회복 방법
    - 프로세스 중단(process termination)
        - 방법1
            - 교착 상태와 관련된 모든 프로세스를 중단시킨다.
        - 방법2
            - 교착 상태와 관련된 프로세스를 하나씩 중단 시키며, 교착 상태가 해결됐는지 확인

    - 자원 선점(resource preemption)
        - 교착상태 발생 시, 하나의 프로세스가 소유하고 있는 자원을 다른 프로세스에게 할당하여 교착 상태를 해결하는 방법
        - 자원을 선점당하는 프로세스는 비용이 최소로 발생하는 프로세스로 선정한다.
            - 해당 프로세스는 문제가 발생하지 않은 `안전 상태(safe state)`로 롤백(rollback)한다.
        - 기아 현상이 발생할 수 있다.
            - `자원 선점`방법 이용 시 하나의 프로세스만 여러 번 자원을 선점당할 수 있다.
            - 자원을 선점당하는 프로세스 선정 시 `롤백(rollback)` 횟수도 고려하면 기아 현상을 어느 정도 해결할 수 있다.

<br>

### ✔️ 교착 상태 해결법 - 무시
- 교착 상태에 대해서 아무런 조치도 취하지 않는 방법
    - 교착 상태가 발생하더라도 처리를 사용자에게 맡긴다.
    - 실제로 교착 상태는 자주 발생하지 않는다.
    - 따라서, 교착 상태를 방지하는 방법을 적용하는 게 오히려 오버헤드일 수 있다.
    - 현재의 운영체제는 대부분 교착 상태에 대해서 이 방법을 이용한다

<br>

### 📚 참고 자료
- [KOCW 운영체제 Ch.Deadlock- 반효경 교수님](http://www.kocw.net/home/search/kemView.do?kemId=1046323)

<br>

<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="크리에이티브 커먼즈 라이선스" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a>