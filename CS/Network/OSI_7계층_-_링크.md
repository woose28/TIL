# 링크 계층
## 링크 계층에서 하는 일

링크 계층은 각 호스트에서 발생한 패킷이 라우터까지 전달될 수 있도록 일을 한다.

대표적으로 두 가지 프레임이 동시에 충돌이 발생했을 때 프레임이 정상적으로 전송될 수 있도록 처리하는 일을 한다.

<br />

## 링크 계층 용어

- 미디엄
    - 전파(프레임)를 전달하는 매개체

<br />

## 링크 계층의 전송 단위: 프레임

네트워크 계층에서 전달된 패킷이 프레임의 데이터 부분에 담긴다. 프레임의 헤더 부분은 프로토콜 마다 다르게 구현돼 있다.

링크 계층에서 사용할 수 있는 프로토콜의 종류는 매우 많으며 대표적으로 이더넷, 와이파이, LTE 등이 있다.

<br />

## 네트워크 인터페이스 카드

- 링크 계층은 네트워크 인터페이스 카드에 기능이 구현돼 있다.
    - 와이파이를 사용한다면 와이파이 카드에 구현돼 있고, 이더넷을 사용한다면 이더넷 카드에 기능이 구현돼 있다.

<br />

## Multiple Access Link의 종류

- point-to-point
    - 이더넷에서 switch와 host가 연결된 방식이다.
- broadcast(shared wire or medium)
    - 오래된 이더넷, wifi 등에서 사용하는 방식이다.

<br />

## MAC(Multiple Access Control)  프로토콜

링크 계층에서 발생하는 여러 프레임을 충돌하지 않도록 만들어주는 프로토콜이다.

MAC 프로토콜의 크게 세 가지로 분류된다.

1. channel partitioning
2. random access
3. taking turns

<br />

## Chanel Partitioning Protocol

채널을 특정한 기준으로 나눠서 각 호스트에게 할당하는 방식이다. 해당 방식은 충돌 발생을 미연에 방지할 수는 있는 장점이 있다. 하지만 채널 자원의 낭비가 발생하는 단점이 있다.

<br />

### TDMA(Time Division Multiple Access)

- 각 호스트에게 시간을 배정해서, 배정된 시간에만 데이터를 전송할 수 있도록 만든 프로토콜이다.
- 충돌은 발생하지 않으나 모든 호스트가 항상 통신하는 것은 아니기 때문에 낭비가 발생한다.

<br />

### FDMA(Frequence Division Multiple Access)

- 호스트 마다 주파수를 배정해서 통신하도록 만드는 프로토콜이다.
- 대역폭(bandwidth)이 1/N 되는 단점이 있다.

채널 디비전 프로토콜은 낭비가 심한 문제가 있다.

<br />

## Random Access Protocol

채널을 나누지 않고 호스트들이 자유롭게 프레임을 전송하는 방식이다. 해당 방식은 충돌을 허용하기 때문에 충돌이 발생했을 때 복구하는 규칙이 필요하다.

<br />

### CSMA

- CSMA는 프레임을 전송하기 전에 다른 호스트가 프레임을 전송 중인지 확인하고 프레임을 전송한다.
    - 다른 호스트에서 프레임을 전송 중이라면(채널에 데이터가 전송 중 이라면) 바로 프레임을 전송하지 않고 대기한다.
    - 그렇지 않다면 프레임을 전송한다.
    - 하지만 전파가 전달되는 속도에 의해서 동시에 두 프레임이 데이터 전송을 시작할 수 있다.

<br />

### CSMA/CD

- CSMA/CD는 출동이 발생했을 때, 이를 감지하고 프레임 전송을 중단하는 방식이다.
- 랜덤한 시간동안 대기한 후 전송이 중단된 프레임은 다시 처음부터 전송한다.
    - 대기 시간은 짧을수록 좋다. 하지만 대기 시간을 짧게 설정할수록 다시 충돌이 발생할 확률이 높아진다. 따라서 재충돌이 발생하면 랜덤한 대기 시간을 더 길게 설정한다. 대기 시간은 binary exponential 규칙으로 증가시킨다.

💡동시에 프레임을 전달하는 호스트가 많을수록 대기 시간이 길어진다. 즉, 네트워크 속도가 느려졌다고 느낀다.

<br />

## Taking turns MAC Protocol

channel division protocol과 random access protocol의 장점을 합치려는 프로토콜이다. 하지만 현실적인 문제들로 사용되지 않는다.

<br />

### Polling 방식

- 일반 호스트는 master 호스트에게 프레임을 전달할 수 있는 권리를 받은 후 프레임을 전송하는 방식이다.
- 하지만 polling 방식은 권리를 받는 과정에서 overhead가 발생하는 단점이 있다.

<br />

### Token passing 방식

- 토큰이 있는 호스트만 프레임을 전송하는 방식이다. 프레임을 전송한 후에 다른 호스트에게 토큰을 넘긴다.
- 하지만 토큰이 유실된다면 모든 호스트가 프레임을 전송할 수 없는 문제가 발생한다.

<br />

## 이더넷(Ethernet)

많이 사용되는 유선 LAN 기술이다.

새로운 호스트가 추가되면 스위치(switch) 장비에 추가로 연결하는 star 형식으로 연결한다.

<br />

### 이더넷 프레임

데이터 부분에 네트워크 계층에서 전달된 패킷이 저장된다.

이더넷 프레임의 헤더의 대표적인 필드는 다음과 같다.

1. source address
    - 출발지 MAC 주소가 저장된다.
    - 헤더 필드의 크기는 48bit이다.
2. dest address
    - 도착지 MAC 주소가 저장된다.
    - 헤더 필드의 크기는 48bit이다.
3. type
    - 데이터 부분에 담긴 데이터의 종류
4. preamble
    - receiver와 sender 사이의 clock rate를 동기화하는 데 사용된다.

💡이더넷은 MAC 프로토콜로 CSMA/CD 방식을 이용한다.

유선 상황에서는 프레임의 충돌만 없으면 매우 높은 확률로 프레임이 잘 전송된다. 하지만 충돌이 발생했다면 프레임이 잘 전송되지 않을 수 있다. 따라서 충돌을 감지하는 작업은 온전한 통신을 위해서 중요하다.

충돌이 발생하는 경우를 두 가지로 나눌 수 있다.

1. 호스트에서 프레임을 전송하는 도중에 충돌이 발생한 경우
    - 해당 경우에는 호스트에서 충돌을 감지할 수 있다.
    - 따라서 CSMA/CD의 대기 방식으로 프레임을 재전송할 수 있다.
2. 호스트에서 프레임을 전송하고 충돌이 발생한 경우
    - 해당 경우에는 호스트에서 충돌을 감지할 수 없다.
    - 때문에 해당 상황은 발생하면 안 된다.
    - 따라서 이더넷에서는 Minimum Frame Size를 정해서 충돌이 1번 경우처럼 발생하도록 만든다.
        - 전송한 프레임이 Minimum Frame Size보다 작다면 padding 값을 추가한다.
    
<br />

## MAC Address

- 네트워크 인터페이스 카드가 생성되는 순간 정해진다. MAC address는 변경할 수 없다. 덕분에 MAC은 각 기기를 식별할 수 있는 고유 번호를 사용된다.
- MAC address는 48bit이다.
    - 읽기 쉽도록 16bit씩 나눠서 표현한다.

각 호스트에는 포워딩 테이블이 있다. 요청이 발생할 때 IP주소를 확인한 후 적절한 기기에 요청을 전달한다.

💡호스트의 포워딩 테이블에는 라우터(Gateway)의 ip주소가 저장돼 있다. 이는 DHCP를 통해 IP를 할당받을 때 함께 받는다.
💡프레임을 만들기 위해서는 도착지의 MAC address가 필요하다. 이를 알기 위해서 ARP 쿼리를 사용한다.

<br />

## ARP Query

- IP 주소에 해당하는 호스트의 MAC 주소를 조회하는 쿼리이다.
- broadcast 방식으로 전송한다.
- ARP Query에 대한 응답은 ARP Response이며 이는 ARP Query를 보낸 호스트에만 전송된다.
- 각 호스트에는 MAC 주소를 저장하는 ARP Table이 있다.
    - ARP Table의 컬럼은 대표적으로 IP 주소, MAC 주소, TTL 등이 있다.
    

💡라우터에서도 다음에 정보를 전달할 장비의 MAC 주소를 알아내기 위해 ARP Table을 참조한다.
💡네트워크 계층 장비들은 포워딩 테이블로 다음 네트워크 장비의 IP 주소를 조회한 후, 조회한 IP 주소로 ARP Table에 다음 네트워크 계층 장비의 MAC 주소를 조회한다.
💡ARP는 네트워크 계층의 프로토콜이다.
💡ARP Broadcast의 범위는 같은 서브넷의 범위이다. 즉 같은 router로 연결된 범위이다.

<br />

## 스위치

- 최근 이더넷은 스위치 장비를 중심으로 start 방식으로 연결돼 있다.
- 각 호스트에서 스위치 장비로 전송되는 프레임은 독립적인 회선에서 전송된다.
- 스위치는 연결된 호스트와 인터페이스 정보를 스스로 채워 넣고 관리한다.
    - 스위치 자체 테이블을 가지고 있으면 컬럼은 MAC 주소, interface, TTL 등이 있다.
    - 스위치는 프레임을 받았을 때, 프레임 헤더의 source address를 확인한 후 스위치 테이블을 채워 넣는다.
    - 만약, 스위치 테이블에 저장되지 않은 MAC 주소라면 스위치는 모든 장비에 프레임을 전송한다. 이를 flood 현상이라 한다.
- 스위치의 인터페이스에는 또 다른 스위치가 연결될 수 있다. 이런 방식으로 이더넷 규모를 무한정으로 증가시킬 수 있다.
- 스위치에서 전달받은 프레임을 다른 호스트에게 전달하는 작업을 `스위칭`이라고 한다.
    - 이는 라우터의 `포워딩`과 유사하다.
- 스위치는 MAC 주소를 가지고 있지 않다. 따라서 호스트들은 스위치 장비의 존재를 인식하지 못한다.

💡데이터 통신을 위해 사용되는 테이블 종류은 포워딩 테이블, ARP 테이블, 스위치 테이블이 있다. 각 테이블의 차이점은 아래의 표와 같다.
|  | 포워딩 테이블 | ARP 테이블 | 스위치 테이블 |
| --- | --- | --- | --- |
| 목적 | 전달받은 패킷을 전달할 네트워크 장비의 IP 주소를 조회하기 위해 사용된다. | IP주소로 기기의 MAC 주소를 조회하기 위해 사용된다. | 스위치 장비에서 들어온 프레임의 dest address를 확인한 후 알 맞은 장비로 전달하기 위해 사용된다. |
| 동작하는 계층 | 네트워크 계층 | 네트워크 계층 | 링크 계층 |
| 존재하는 장치 | 네트워크 계층 장비 | 네트워크 계층 장비 | 링크 계층 장비 |

<br />

## Data center networks

기업들은 수많은 서버(호스트)를 스위치로 연결해두고, 그 스위치를 또 다른 스위치와 연결해서 규모가 큰 LAN을 구성한다. 이를 Server Farm이라고 한다.

<br />

## 데이터 전송 시나리오

IP를 할당받고 TCP 통신으로 데이터를 전달하는 시나리오는 다음과 같다.

1. Client는 DHCP 프로토콜을 통해 IP 주소와 통신에 필요한 주소를 할당받는다.
    - 이때 application 계층에서는 transaction ID 데이터를 보낸다.
    - 이때 UDP 세그먼트의 source port와 dest port는 다음과 같다.
        - source port는 67번 포트이다.
        - dest port는 68번 포트이다.
    - 이때 IP 패킷의 source ip와 dest ip는 다음과 같다.
        - source ip는 0.0.0.0(아직 IP주소를 할당받기 전이기 때문이다.)
        - dest ip는 브로드캐스트(255.255.255.255)이다.
    - 이때 이더넷 프레임의 source address와 dest address는 다음과 같다.
        - source address는 자신의 MAC 주소이다.
        - dest address는 브로드캐스트(FF-FF-FF-FF-FF)이다.
2. DHCP 서버가 DHCP discover 요청을 받으면 DHCP offer → DHCP request → DHCP ACK 과정을 거치면서 Client는 IP주소와 통신에 필요한 정보(서브넷 마스크, DNS 서버 IP, Gateway IP 주소)를 받는다.
3. Client는 Gateway IP주소를 받은 이후 네트워크 외부로 요청을 보낼 경우 Gateway를 거쳐가도록 포워딩 테이블(Forwarding Table)을 구성한다.
4. Client가 외부 인터넷으로 요청을 보낸다.
    - TCP 통신을 위한 application 데이터, TCP 세그먼트, IP 패킷을 생성한다.
    - 프레임을 생성하기 위해 ARP Table에서 Gateway의 MAC 주소를 조회한다.
        - Client의 포워딩 테이블을 조회해서 Gateway의 IP주소를 조회한다.
        - 만약 ARP Table에서 Gateway의 MAC 주소를 조회할 수 없다면, ARP Query를 통해 Gateway의 MAC 주소를 조회한다.
    - 프레임의 source address와 dest address를 각각 자신의 MAC주소와 Gateway의 MAC 주소로 설정한다.
5. Gateway에서는 전달받은 데이터를 확인하면서 다음 네트워크 목적지를 정한다.
    - IP 패킷의 dest IP을 이용하여 포워딩 테이블에서 다음 네트워크의 IP 주소를 조회한다.
    - 다음 네트워크의 IP 주소를 이용해서 ARP 테이블에서 다음 네트워크 장비의 MAC 주소를 조회한다.
        - 만약 ARP 테이블에서 MAC 주소가 조회되지 않는다면 ARP 쿼리를 날린다.
    - 새로운 프레임을 생성하여 다음 네트워크로 데이터를 전달한다.
6. Server에 도착할 때까지 5번 과정을 반복한다.
7. Server에 도착하면 3-handshake 과정을 수행하면서 각 소켓을 연결한다.
    - 3-handshake 과정도 1~6번 과정과 유사하게 네트워크 통신 과정을 거친다.

<br />

## 무선 상황에서의 통신
무선 통신과 모빌리티 통신이 구분된다.
- 무선 통신
    - 선이 없는 상태에서의 통신을 의미한다.
- 모빌리티 통신
    - LTE, 3g 등 이동하면서 Access point를 변경되는 통신을 의미한다.

<br />

## 무선 통신

무선 통신은 처음 연결되는 네트워크 장비와 무선으로 연결되는 통신을 의미한다.
네트워크 장비는 다른 장비들과 유선으로 연결돼 있다.

무선 통신의 특징
1. 무선 상황에서는 거리가 멀어질수록 진폭이 줄어드는 현상이 발생한다. 때문에 거리가 멀어질수록 신호 세기가 약해진다.
    - 유선 상황에서는 전파의 진폭이 유지된다. 즉 거리가 멀어도 신호의 세기가 유지된다.
2. 무선 통신에서는 충돌 감지(Collision Detection)이 불가능하다.
    - 현재 장비에서 보내는 전파의 진폭이 다른 호스트들에서 오는 전파보다 크기 때문에 다른 전파는 노이즈로 취급된다.

<br />

## Wifi

- Wifi의 기술적인 이름은 IEEE 802.11 Wireless LAN이다.
- Wifi의 버전이 증가하면서 데이터 전송 속도가 증가한다.
- 와이파이 장비(와이파이 공유기)를 AP(Access Point)라고 한다.
- 와이파이는 스위치와 유선으로 연결돼 있다.
- 와이파이는 주기적으로 자신의 정보를 전파를 통해 보낸다.
    - 약 초당 10번의 빈도로 beacon에 담아 정보를 전파한다.
    - beacon에는 AP의 MAC Address 등 통신에 필요한 정보가있다.
- 와이파이는 각 프레임의 충돌을 해결하기 위해 MAC 프로토콜로 CSMA/CA를 사용한다.
- 2.4GHz 대역을 사용한다.

💡 가정에 있는 무선 공유 장비는 애플리케이션 계층까지 구현돼 있다. 이는 무선 공유기에서 DHCP 기능이 구현돼 있기 때문이다. 또한 무선 공유기가 일종의 Gateway 역할을 한다.
💡AP는 무선 통신 부분에서는 통신할 때는 Wifi 프레임을 사용하여 통신하고, 유선으로 연결된 부분에서는 이더넷 프레임을 사용하여 통신한다.

<br />

### CSMA/CA(=CSMA/Collision Avoidance) + RTS-CTS

- 무선 통신에서는 충돌을 감지할 수 없기 때문에 Link 계층의 ACK를 사용한다.
    - 충돌을 감지할 수 없기 때문에 CSMA/CD와 다르게 데이터 전송이 시작되면 충돌이 발생해도 프레임을 전부 전송한다. 때문에  낭비되는 자원의 크기가 크다.
    - 낭비되는 자원의 크기를 최소화하기위해 RTS-CTS 방식이 사용된다.
- 기본적인 CSMA의 동작은 유선의 CSMA 유사하다.
    - 채널에 현재 전송 중인 데이터가 없다면 약간의 대기 시간(DIFS) 동안 기다린 후 데이터를 전송한다.
    - 채널에 현재 전송 중인 데이터가 있다면 랜덤한 시간 동안 대기 후 채널에 현재 전송 중인 데이터가 있는지 다시 확인한다.
- 다른 점은 receiver가 온전한 데이터를 받으면 약간의 시간 동안(SIFS) 대기 후 sender에게 ACK를 보낸다.
    - sender는 ACK를 받지 않으면 충돌이 발생했다고 판단한 후 데이터를 재전송한다.

<br />

**Collision Avoidance RTS-CTS**

- RTS(=Ready To Send) 데이터 송신 권한을 요청하는 메시지
    - 즉 본격적으로 프레임을 전송하기 전에 작인 데이터인 RTS 통해 통신이 가능한지 확인하는 절차를 거친다.
    - 이를 통해 충돌로 인해 프레임 데이터가 전부 낭비되는 문제를 해결한다.
    - RTS를 보낸 후 CTS(일종의 ACK)가 오지 않으면 Sender는 랜덤한 시간 동안 대기를 한다.
    - RTS에는 통신에 필요한 데이터 크기와 이용 시간 정보가 담겨있으며 이는 브로드캐스트 방식으로 전송된다.
- CTS(=Clear To Send) 데이터 송신을 허락하는 메시지 CTS에는 시간정보가 함께 전달된다.
    - CTS 또한 Sender 이외의 다른 호스트들에게 전달한다.
    - 다른 호스트들은 CTS에 담긴 시간 동안 RTS를 AP에게 보내지 않는다.

💡무선 통신에서는 AP에게 통신하기 위해서 서로 다른 host가 경쟁한다.

<br />

### Wifi Frame

와이파이 프레임에서의 대표적인 헤더
- 4개의 address 필드
    - address1
        - 프레임을 받는 장치의 MAC 주소
        - 데이터 전송이 Host → AP인 경우 AP의 MAC 주소이다.
        - 데이터 전송이 AP → Host인 경우 Host의 MAC 주소이다.
    - address2
        - 프레임을 전송하는 장치의 MAC 주소
    - address3
        - AP에 연결된 라우터 장치의 MAC 주소
        - IP패킷을 처리할 MAC 주소이다.
    - address4
        - 거의 사용되지 않는 헤더 필드이다.
- frame control
    - 2byte의 크기를 가진다.

frame control 필드의 대표적인 서브 필드는 다음과 같다.
- Type
    - 현재 프레임의 종류를 나타낸다.
    - RTS, CTS, ACK, data 총 네 가지 타입이 존재한다.
    - 서브 필드는 2bit의 크기를 가진다.

💡 AP와 라우터는 유선으로 연결돼 있다. 따라서 이더넷 통신을 한다. 이더넷 통신을 할 때 와이파이 프레임 헤더의 address2를 source address 필드에, address3를 dest address 필드에 넣어서 통신한다.
💡 AP는 링크 계층 장치이기 때문에 네트워크 계층의 포워딩 작업을 할 수 없다. 즉, IP 패킷을 확인하고 다음 장치로 패킷을 전달할 수 없다. 때문에 와이파이 프레임 헤더에 addres1(AP의 MAC 주소)이 필요하다. 
💡 유선 통신에서 AP는 MAC주소가 없지만, 무선 통신에서는 AP는 MAC 주소가 있다. 무선통신에서 전파의 정보를 여러 기기에서 수신할 수 있기 때문에 프레임을 수신할 장비의 MAC 주소를 이용해서 기기를 특정지어야한다.
💡AP의 MAC주소는 AP들이 주기적으로 보내는 beacon 메시지를 통해 얻을 수 있다.
💡라우터의 MAC주소는 DHCP를 통해 라우터의 IP 주소를 얻은 후 ARP를 통해 라우터의 MAC 주소를 얻는다.

<br />

## Mobility within same subnet

동일한 네트워크 id를 사용하는(=같은) 서브넷 안에서는 AP가 변경된 경우에 IP 주소는 변경할 필요가 없다. 따라서 TCP 통신이 유지된다. 하지만 다른 네트워크의 AP로 연결이 변경된 경우에는 IP주소가 변경되기 때문에 TCP 통신이 끊긴다.

<br />

## Rate adaptation

와이파이의 데이터 전송 속도는 AP와 호스트의 거리에 반비례한다. 즉, 와이파이의 데이터 전송 속도는 고정돼 있지 않다. 이는 거리에 비례해서 데이터 통신 중 에러가 발생할 확률이 증가하는 현상과 관련 있다.

데이터 통신 중 에러가 발생했을 때, 이를 해결하기 위해 별도의 에러처리 데이터가 필요하다. 때문에 에러 처리 기능을 더 강화할수록 실제로 전송해야 하는 에러처리 데이터가 커진다. 이는 같은 데이터 크기의 데이터를 전달할 때 에러처리 성능이 높을수록 실제로 전송하는 데이터의 크기는 줄어든다는 것을 의미한다. 이를 아래와 같이 정리할 수 있다.

- 단위 시간 동안 데이터 전송 속도가 빠른 인코딩 방식은 에러처리 능력이 떨어진다.
- 단위 시간 동안 데이터 전송 속도가 느린 인코딩 방식은 에러처리 능력이 뛰어나다.

따라서 와아파이는 AP로부터 먼 거리에 있는 호스트와의 통신을 안정적으로 하기위해 데이터 전송속도가 느린 인코딩 방식을 사용해서 에러처리 능력이 높인다. 때문에 AP로부터 거리가 먼 호스트는 와이파이로 통신하는 속도가 느려지게 된다.
