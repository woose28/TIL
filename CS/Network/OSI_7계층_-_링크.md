# 링크 계층
## 링크 계층에서 하는 일

링크 계층은 각 호스트에서 발생한 패킷이 라우터까지 전달될 수 있도록 일을 한다.

대표적으로 두 가지 프레임이 동시에 충돌이 발생했을 때 프레임이 정상적으로 전송될 수 있도록 처리하는 일을 한다.

<br />

## 링크 계층 용어

- 미디엄
    - 전파(프레임)를 전달하는 매개체

<br />

## 링크 계층의 전송 단위: 프레임

네트워크 계층에서 전달된 패킷이 프레임의 데이터 부분에 담긴다. 프레임의 헤더 부분은 프로토콜 마다 다르게 구현돼 있다.

링크 계층에서 사용할 수 있는 프로토콜의 종류는 매우 많으며 대표적으로 이더넷, 와이파이, LTE 등이 있다.

<br />

## 네트워크 인터페이스 카드

- 링크 계층은 네트워크 인터페이스 카드에 기능이 구현돼 있다.
    - 와이파이를 사용한다면 와이파이 카드에 구현돼 있고, 이더넷을 사용한다면 이더넷 카드에 기능이 구현돼 있다.

<br />

## Multiple Access Link의 종류

- point-to-point
    - 이더넷에서 switch와 host가 연결된 방식이다.
- broadcast(shared wire or medium)
    - 오래된 이더넷, wifi 등에서 사용하는 방식이다.

<br />

## MAC(Multiple Access Control)  프로토콜

링크 계층에서 발생하는 여러 프레임을 충돌하지 않도록 만들어주는 프로토콜이다.

MAC 프로토콜의 크게 세 가지로 분류된다.

1. channel partitioning
2. random access
3. taking turns

<br />

## Chanel Partitioning Protocol

채널을 특정한 기준으로 나눠서 각 호스트에게 할당하는 방식이다. 해당 방식은 충돌 발생을 미연에 방지할 수는 있는 장점이 있다. 하지만 채널 자원의 낭비가 발생하는 단점이 있다.

<br />

### TDMA(Time Division Multiple Access)

- 각 호스트에게 시간을 배정해서, 배정된 시간에만 데이터를 전송할 수 있도록 만든 프로토콜이다.
- 충돌은 발생하지 않으나 모든 호스트가 항상 통신하는 것은 아니기 때문에 낭비가 발생한다.

<br />

### FDMA(Frequence Division Multiple Access)

- 호스트 마다 주파수를 배정해서 통신하도록 만드는 프로토콜이다.
- 대역폭(bandwidth)이 1/N 되는 단점이 있다.

채널 디비전 프로토콜은 낭비가 심한 문제가 있다.

<br />

## Random Access Protocol

채널을 나누지 않고 호스트들이 자유롭게 프레임을 전송하는 방식이다. 해당 방식은 충돌을 허용하기 때문에 충돌이 발생했을 때 복구하는 규칙이 필요하다.

<br />

### CSMA

- CSMA는 프레임을 전송하기 전에 다른 호스트가 프레임을 전송 중인지 확인하고 프레임을 전송한다.
    - 다른 호스트에서 프레임을 전송 중이라면(채널에 데이터가 전송 중 이라면) 바로 프레임을 전송하지 않고 대기한다.
    - 그렇지 않다면 프레임을 전송한다.
    - 하지만 전파가 전달되는 속도에 의해서 동시에 두 프레임이 데이터 전송을 시작할 수 있다.

<br />

### CSMA/CD

- CSMA/CD는 출동이 발생했을 때, 이를 감지하고 프레임 전송을 중단하는 방식이다.
- 랜덤한 시간동안 대기한 후 전송이 중단된 프레임은 다시 처음부터 전송한다.
    - 대기 시간은 짧을수록 좋다. 하지만 대기 시간을 짧게 설정할수록 다시 충돌이 발생할 확률이 높아진다. 따라서 재충돌이 발생하면 랜덤한 대기 시간을 더 길게 설정한다. 대기 시간은 binary exponential 규칙으로 증가시킨다.

💡동시에 프레임을 전달하는 호스트가 많을수록 대기 시간이 길어진다. 즉, 네트워크 속도가 느려졌다고 느낀다.

<br />

## Taking turns MAC Protocol

channel division protocol과 random access protocol의 장점을 합치려는 프로토콜이다. 하지만 현실적인 문제들로 사용되지 않는다.

<br />

### Polling 방식

- 일반 호스트는 master 호스트에게 프레임을 전달할 수 있는 권리를 받은 후 프레임을 전송하는 방식이다.
- 하지만 polling 방식은 권리를 받는 과정에서 overhead가 발생하는 단점이 있다.

<br />

### Token passing 방식

- 토큰이 있는 호스트만 프레임을 전송하는 방식이다. 프레임을 전송한 후에 다른 호스트에게 토큰을 넘긴다.
- 하지만 토큰이 유실된다면 모든 호스트가 프레임을 전송할 수 없는 문제가 발생한다.

<br />

## 이더넷(Ethernet)

많이 사용되는 유선 LAN 기술이다.

새로운 호스트가 추가되면 스위치(switch) 장비에 추가로 연결하는 star 형식으로 연결한다.

<br />

### 이더넷 프레임

데이터 부분에 네트워크 계층에서 전달된 패킷이 저장된다.

이더넷 프레임의 헤더의 대표적인 필드는 다음과 같다.

1. source address
    - 출발지 MAC 주소가 저장된다.
    - 헤더 필드의 크기는 48bit이다.
2. dest address
    - 도착지 MAC 주소가 저장된다.
    - 헤더 필드의 크기는 48bit이다.
3. type
    - 데이터 부분에 담긴 데이터의 종류
4. preamble
    - receiver와 sender 사이의 clock rate를 동기화하는 데 사용된다.

💡이더넷은 MAC 프로토콜로 CSMA/CD 방식을 이용한다.

유선 상황에서는 프레임의 충돌만 없으면 매우 높은 확률로 프레임이 잘 전송된다. 하지만 충돌이 발생했다면 프레임이 잘 전송되지 않을 수 있다. 따라서 충돌을 감지하는 작업은 온전한 통신을 위해서 중요하다.

충돌이 발생하는 경우를 두 가지로 나눌 수 있다.

1. 호스트에서 프레임을 전송하는 도중에 충돌이 발생한 경우
    - 해당 경우에는 호스트에서 충돌을 감지할 수 있다.
    - 따라서 CSMA/CD의 대기 방식으로 프레임을 재전송할 수 있다.
2. 호스트에서 프레임을 전송하고 충돌이 발생한 경우
    - 해당 경우에는 호스트에서 충돌을 감지할 수 없다.
    - 때문에 해당 상황은 발생하면 안 된다.
    - 따라서 이더넷에서는 Minimum Frame Size를 정해서 충돌이 1번 경우처럼 발생하도록 만든다.
        - 전송한 프레임이 Minimum Frame Size보다 작다면 padding 값을 추가한다.
    
<br />

## MAC Address

- 네트워크 인터페이스 카드가 생성되는 순간 정해진다. MAC address는 변경할 수 없다. 덕분에 MAC은 각 기기를 식별할 수 있는 고유 번호를 사용된다.
- MAC address는 48bit이다.
    - 읽기 쉽도록 16bit씩 나눠서 표현한다.

각 호스트에는 포워딩 테이블이 있다. 요청이 발생할 때 IP주소를 확인한 후 적절한 기기에 요청을 전달한다.

💡호스트의 포워딩 테이블에는 라우터(Gateway)의 ip주소가 저장돼 있다. 이는 DHCP를 통해 IP를 할당받을 때 함께 받는다.

하지만 프레임을 만들기 위해서는 도착지의 MAC address가 필요하다. 이를 알기 위해서 ARP 쿼리를 사용한다.

<br />

## ARP Query

- IP 주소에 해당하는 호스트의 MAC 주소를 조회하는 쿼리이다.
- broadcast 방식으로 전송한다.
- ARP Query에 대한 응답은 ARP Response이며 이는 ARP Query를 보낸 호스트에만 전송된다.
- 각 호스트에는 MAC 주소를 저장하는 ARP Table이 있다.
    - ARP Table의 컬럼은 대표적으로 IP 주소, MAC 주소, TTL 등이 있다.
    

💡라우터에서도 다음에 정보를 전달할 장비의 MAC 주소를 알아내기 위해 ARP Table을 참조한다.

<br />

## 스위치

- 최근 이더넷은 스위치 장비를 중심으로 start 방식으로 연결돼 있다.
- 각 호스트에서 스위치 장비로 전송되는 프레임은 독립적인 회선에서 전송된다.
- 스위치는 연결된 호스트와 인터페이스 정보를 스스로 채워 넣고 관리한다.
    - 스위치 자체 테이블을 가지고 있으면 컬럼은 MAC 주소, interface, TTL 등이 있다.
    - 스위치는 프레임을 받았을 때, 프레임 헤더의 source address를 확인한 후 스위치 테이블을 채워 넣는다.
    - 만약, 스위치 테이블에 저장되지 않은 MAC 주소라면 스위치는 모든 장비에 프레임을 전송한다. 이를 flood 현상이라 한다.
- 스위치의 인터페이스에는 또 다른 스위치가 연결될 수 있다. 이런 방식으로 이더넷 규모를 무한정으로 증가시킬 수 있다.
- 스위치에서 전달받은 프레임을 다른 호스트에게 전달하는 작업을 `스위칭`이라고 한다.
    - 이는 라우터의 `포워딩`과 유사하다.
- 스위치는 MAC 주소를 가지고 있지 않다. 따라서 호스트들은 스위치 장비의 존재를 인식하지 못한다.
